# GeoJSON 地图编辑器 - 更新日志

本文档记录 GeoJSON 地图编辑器的所有版本更新，从新到旧排列。

---

## [v2.9.0] - 2026-01-13

### ✨ 新功能

#### 统一悬浮面板系统（Floating Panel System）
- **毛玻璃效果**：所有面板 `backdrop-filter: blur(14px)` + 半透明背景
- **统一基类**：`.floating-panel` 基类定义圆角、阴影、边框
- **CSS 变量**：`--bg-glass`、`--border-glass`、`--shadow-float` 等统一管理

#### 左侧 Dock 折叠模式
- **图标模式**：折叠后显示 5 个图标（搜索/导入/图层/历史/工具）
- **Tooltip**：悬停显示功能名称
- **一键展开**：点击图标展开对应功能模块

#### 图层管理面板升级
- **固定头部**：标题 + 关闭按钮固定在顶部
- **搜索栏**：实时过滤图层列表
- **可折叠分组**：图层列表/图层详情/统计汇总 可独立折叠
- **滚动列表**：`max-height: 40vh` + `overflow-y: auto`

#### 表格拖拽调节高度
- **拖拽手柄**：顶部可拖拽调节高度
- **范围限制**：200px ~ 70vh
- **地图刷新**：释放后自动 `map.invalidateSize()`

### 🐛 Bug 修复

#### 地图不显示问题
- **问题**：UI 重构后地图无法显示
- **原因**：`layer-panel-content` 未正确关闭，`#map` 被嵌套在隐藏的 layerPanel 内
- **修复**：添加正确的关闭标签并移动 `#map` 到正确位置

#### Dock 图标不可见
- **问题**：折叠后 Dock 按钮显示为空白
- **修复**：添加 `.dock-icon i` 显式样式（font-size/color/opacity）

#### Leaflet.draw 图标不可见
- **问题**：绘制工具按钮是空白方块
- **原因**：`background:` 简写覆盖了 sprite `background-image`
- **修复**：改用 `background-color:` 保留 sprite 图标

#### 右下角工具菜单毛玻璃
- **问题**：背景不透明，blur 无效
- **修复**：`background: rgba(20,20,20,0.55)` + `backdrop-filter: blur(16px)`

### 🎨 UI 优化

- **缩放控件**：移至左下角，44×44px 点击区域
- **自定义滚动条**：6px 宽度，透明轨道
- **按钮系统**：主按钮 `#1677FF`、次按钮描边、文字按钮

### 📁 文件变更

| 文件 | 变更 |
|------|------|
| `style.css` | +800 行（悬浮面板、Dock、图层面板、毛玻璃样式） |
| `index.html` | 重构左侧面板结构、图层面板结构 |
| `script.js` | 新增 toggleLayerPanel/toggleLayerSection/filterLayers |
| `table-view.js` | 新增拖拽调节高度功能 |
| `table-view-styles.css` | 表格面板固定定位 + 拖拽手柄样式 |

---

## [v2.8.0] - 2026-01-13

### ✨ 新功能

#### 快照浏览模式
- **进入浏览**：点击历史地图模块的 👁️ 按钮
- **快照切换**：浏览模式下点击快照列表项立即加载
- **状态隔离**：进入时保存编辑态，退出时自动恢复
- **禁用编辑**：浏览模式下绘制控件/导入/清空按钮禁用
- **应用按钮**：可将浏览的快照应用到编辑态

#### 表格定位按钮
- **新增列**：表格末尾添加「定位」按钮列
- **行点击**：仅选中，不触发地图跳转
- **按钮点击**：flyTo + 高亮 + 展开同坐标组

#### 图层搜索功能
- **搜索栏**：图层详情面板顶部添加搜索输入框
- **模糊匹配**：按名称/类型/地址匹配
- **定位结果**：点击搜索结果 flyTo + 高亮

### 🐛 Bug 修复

#### GeoJSON 导入「替换」模式修复
- **问题**：选择「替换现有图层」后点击确认无反应
- **原因**：`resetImportState()` 调用未定义方法导致中断
- **修复**：
  - 每个清理步骤独立 try/catch
  - 方法调用前检查 `typeof X === 'function'`
  - 添加详细 console.log 便于排查

#### 快照数据隔离修复
- **问题**：A/B 快照切换后数据叠加
- **修复**：
  - 加载快照前调用 `_resetRuntimeState()`
  - 彻底清空 MarkerGroup/drawnItems/customGroups/Selection/Table

### 🎨 UI 优化

#### 图层详情面板
- 样式分布：最多显示 10 条（原 5 条），超出滚动
- 显示标记数量统计

#### 表格滚动条
- 添加横向/纵向滚动支持
- 自定义滚动条样式

### 📦 文件变更
- `timeline-manager.js` - 添加浏览模式（~220 行）
- `table-view.js` - 定位按钮列 + locateMarkerOnMap（~40 行）
- `table-view-styles.css` - 定位按钮 + 滚动条样式
- `script.js` - 搜索功能 + 导入修复（~150 行）
- `style.css` - 浏览模式 + 搜索栏样式（~230 行）
- `index.html` - 浏览按钮

---

## [v2.7.1] - 2026-01-12

### 🐛 UI 修复

#### 历史地图模块优化
- 「地图历史」→「历史地图」名称统一
- 保存按钮颜色：绿色 → 蓝色（与整体风格一致）
- 左侧面板收起时，历史地图模块同步隐藏

#### 工具菜单优化
- 菜单项由竖排改为横排显示
- 减少视觉占用空间

### 📦 文件变更
- `index.html` - 修改模块标题
- `style.css` - 按钮颜色、flex-direction、.collapsed 规则

---

## [v2.7.0] - 2026-01-12

### 🎨 UI 优化

#### 「历史地图」模块
- 原名「时间轴」，新名「历史地图」
- 使用 `fa-clock-rotate-left` 图标
- 默认收起状态，点击标题展开/收起
- 保存按钮精简（仅显示 `+` 图标）

#### 右下角工具入口合并
- 合并前：两个独立浮动按钮（表格 + 看板）
- 合并后：单个工具箱按钮 `fa-toolbox`
- 点击弹出工具菜单（表格、看板）
- 点击外部自动关闭菜单

### 📦 文件变更
- `index.html` - 重构时间轴区域 + tools-fab-container
- `style.css` - 添加折叠样式 + 工具菜单样式（~100 行）
- `script.js` - 添加 toggleMapHistory + toggleToolsMenu

---

## [v2.6.0] - 2026-01-12

### ✨ 新功能

#### 时间轴快照系统
- **快照保存**：保存当前地图完整状态
  - 所有标记（含 marker-color/symbol 样式）
  - 视图状态（center, zoom）
  - 自定义组
- **快照加载**：点击时间点恢复该状态
- **快照管理**：重命名、删除
- **localStorage 持久化**

#### 看板统计面板
- **位置**：收起在右下角，展开在右上角
- **显示内容**
  - 当前时间点名称
  - 总标记数
  - 按类型分组统计
  - **颜色色块预览** + **图标预览**
- **实时刷新**：增删改/切换时间点自动刷新

### 📦 文件变更
- `timeline-manager.js` - 新建（~400 行）
- `dashboard-panel.js` - 新建（~250 行）
- `style.css` - 添加 Timeline + Dashboard 样式（~385 行）
- `index.html` - 添加 UI 区域 + 脚本引用

---

## [v2.5.1] - 2026-01-12

### 🐛 关键修复

#### CSS Grid 布局重构
- **问题**：左侧面板与底部表格布局冲突
- **方案**：采用 CSS Grid 重构页面布局
  ```
  body (CSS Grid)
  ├── 列: auto | 1fr | auto
  ├── 行: 1fr | auto
  └── #tableViewPanel → grid-row: 2
  ```
- **效果**
  - 表格收起：面板使用完整高度
  - 表格展开：面板底部不被遮挡
  - 平滑过渡动画（0.3s）
  - 地图自动重绘

### 📦 文件变更
- `style.css` - body 改为 CSS Grid
- `table-view-styles.css` - 移除 fixed 定位
- `table-view.js` - 使用 classList + map.invalidateSize()

---

## [v2.5.0] - 2026-01-12

### ✨ 新功能

#### 自定义组管理器
- **多选模式**
  - 点击「选择标记创建组」进入多选模式
  - 被选中标记显示红色闪烁高亮
  - 可多选任意位置的标记
- **组管理**
  - 创建命名组
  - 重命名、删除
  - 点击组名定位到组成员
- **组导出**：导出组内标记为 GeoJSON
- **localStorage 持久化**

### 📦 文件变更
- `custom-group-manager.js` - 新建（~400 行）
- `style.css` - 添加多选模式样式（~210 行）
- `layer-stats.js` - 增强统计（含自定义组数量）
- `script.js` - 集成多选点击事件

---

## [v2.4.0] - 2026-01-09

### ✨ 新功能

#### 图层统计
- 按类型分组统计
- 全局汇总（总标记数、组数量）
- 实时刷新

#### 四向联动
- Table ↔ 地图 ↔ 图层面板 ↔ 属性编辑器
- SelectionManager 统一状态管理
- 点击任一位置自动同步其他三个组件

### 📦 文件变更
- `selection-manager.js` - 新建
- `layer-stats.js` - 新建
- 多文件集成 SelectionManager

---

## [v2.3.0] - 2026-01-09

### ✨ 新功能

#### 组合标记与放射展开 (Spiderfy)
- **组合显示**
  - 同坐标多标记自动合并为组合标记
  - 组合标记显示红色数量徽标（如 "3"）
  - 坐标判定阈值可配置（`COORD_EPSILON = 1e-6`）
- **放射展开**
  - 点击组合标记以圆形/螺旋布局展开子标记
  - 展开后各子标记可独立选中、编辑
  - 连接线动画效果
- **收起触发**
  - ESC 键收起
  - 点击地图空白处收起
  - 再次点击组合标记收起
- **数据安全**
  - 展开/收起仅影响显示，不修改 GeoJSON 原始坐标
  - 导出时自动还原原始坐标

### 📦 文件变更
- `marker-group.js` - 新建（~350行）
- `style.css` - 添加组合标记样式（~90行）
- `script.js` - 集成 MarkerGroupManager
- `table-view.js` - 支持分组标记枚举与展开
- `index.html` - 引入 marker-group.js

---

## [v2.2.1] - 2026-01-09

### 🐛 关键修复
- **中文字段深度支持**
  - 属性编辑器优先识别中文字段（名称/类型/地址）作为标题
  - 表格视图实现**动态列生成**，自动显示所有业务字段
  - 地图气泡弹窗同步支持中文字段
- **气泡弹窗与按钮修复**
  - 修复左键点击冲突，现在点击标记可同时触发高亮与气泡弹出
  - 修复弹窗内“添加事件”按钮无效的问题，统一 ID 引用逻辑
  - 统一所有导入路径（GeoJSON/Excel/CSV）的气泡绑定逻辑

## [v2.2.0] - 2026-01-09

### 🐛 关键修复

#### 中文字段完整支持
- **修复字段过滤逻辑**
  - 只过滤内部技术字段（`_*`、`marker-*`、`events`）
  - 所有中英文业务字段完整显示
  - 支持：销售等级、加油笔数、钱包会员比例等
- **同步修复**
  - property-editor.js - 属性抽屉
  - table-view.js - 表格视图

#### 右键属性编辑器修复
- 右键点击时设置 `selectedMarker`
- 确保属性编辑器正确获取标记引用
- 与地图高亮状态保持一致

#### 左键事件功能增强
- 左键点击：高亮标记 + 设置选中
- Ctrl+左键：打开属性抽屉
- **双击标记**：打开事件追踪器（新增）

### 📝 文件变更
- `property-editor.js` - 字段过滤重构（~20行）
- `table-view.js` - 同步过滤逻辑（~15行）
- `script.js` - 事件绑定修复（~10行）

---

## [v2.1.0] - 2026-01-08

### ✨ 新功能

#### 表格视图面板
- **Tabulator 集成**
  - 使用 Tabulator.js 专业表格库
  - 虚拟滚动支持（优化大数据集性能）
  - 每个 Feature 独立一行
- **表格功能**
  - 列排序、列筛选
  - 单元格编辑回写
  - 隐藏列支持
- **双向联动**
  - 表格行点击 → 地图定位并高亮
  - 地图选中 → 表格行高亮

### 📝 文件变更
- `table-view.js` - 新建（300+ 行）
- `table-view-styles.css` - 新建（150+ 行）
- `index.html` - 引入 Tabulator + 容器

---

## [v2.0.0] - 2026-01-08

### 🎉 重大更新

#### 标记交互系统重构
- 左键单击：高亮标记（金色脉冲）
- Ctrl + 左键：打开属性抽屉
- 右键菜单：保留所有功能

#### 属性编辑器全新设计
- 侧边抽屉替代 Modal
- 固定高度（max 800px）
- 新增：地址、坐标显示、图标预览
- 快捷操作按钮

#### 同位置多标记支持
- 自动圆形偏移布局
- 保存原始坐标
- 导入/导出完整支持

---

## [v1.2.0] - 2026-01-08

### 🐛 修复

#### 服务器启动问题
- 智能端口检测（8000-8099）
- 避免端口冲突错误

### 📦 新增文件
- `server.py` - 智能 HTTP 服务器

---

## [v1.0.0] - 基础版本

### ✨ 核心功能
- 地图编辑（标记、线条、多边形）
- 自定义图标与颜色
- GeoJSON 导入/导出
- 事件追踪器
- 无限命名存档
- 多种底图切换
