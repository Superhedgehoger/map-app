# GeoJSON 地图编辑器 - 更新日志

本文档记录 GeoJSON 地图编辑器的所有版本更新，从新到旧排列。

---

## [v2.15.0] - 2026-02-02

### ✨ 新功能

#### 📤 动态全字段数据导出
- **新增**: "导出 Excel" 和 "导出 CSV" 按钮（图层面板 → 数据导出区域）
- **动态表头**: 自动收集所有标记的所有属性字段作为列
- **多数据源**: 同时遍历 `drawnItems`、`markerClusterGroup`、`markerGroupManager`
- **中文支持**: CSV 导出使用 BOM 确保 Excel 正确显示中文
- **固定列**: 经纬度始终作为前两列

#### 📷 分享地图截图
- **新增**: "分享地图截图" 按钮，生成纯净地图图片
- **Loading 遮罩**: 截图生成期间显示加载动画
- **预览弹窗**: 生成后预览并支持一键下载 PNG
- **性能优化**: 只截取 `#map` 节点，scale 上限 2x

#### 🎛️ 地图控件重构
- **缩放按钮移入面板**: 左侧面板新增 [+放大] [−缩小] 按钮
- **绘图工具按需显示**: 新增"绘图工具"开关按钮，默认隐藏工具栏
- **截图自动纯净**: 缩放按钮在 HTML 面板中（不在 #map 内），绘图工具默认隐藏

#### 🗑️ 表格删除按钮
- **新增**: 数据表格操作列新增红色"删除"按钮
- **统一删除逻辑**: 复用 `deleteLayer()` 函数，地图/列表/表格三处同步
- **确认提示**: 删除前弹出确认对话框

### 🐛 Bug 修复

#### 清空所有图层三步深层清理
- **修复**: "清空所有图层"后标记/列表依然残留的问题
- **实现**: 三步"焦土"策略
  1. **物理清除**: 移除 DOM/Leaflet 层级所有元素
  2. **数据清除**: 重置内部状态（counters、managers、Sets）
  3. **UI 同步**: 强制更新图层列表、表格、统计

#### 图层列表/表格同步
- **修复**: 清空后图层列表不清空的问题
- **修复**: 上下文菜单删除在清空后失效的问题
- **实现**: `deleteLayer()` 统一处理所有删除场景

#### 双重确认对话框
- **修复**: "清空所有图层"弹出两次确认框的问题
- **原因**: 存在重复的 `clearAllLayers` 函数定义

### 📦 代码重构

- **移除默认缩放控件**: `zoomControl: false` + 删除 `L.control.zoom()`
- **CSS 绘图工具隐藏**: `.leaflet-draw { display: none; }` 作为默认样式
- **toggleDrawToolbar()**: 控制绘图工具栏显示/隐藏

### 📦 代码同步
- 所有修改同步自 Geomap-app 主版本

---

## [v2.14.1] - 2026-01-30

### 🐛 Bug 修复

#### Excel/CSV 导入导出功能完整修复
- **修复**: UI 重构后导入导出按钮无响应问题
- **原因**: 事件绑定代码缺少 null 检查，部分元素不存在时导致后续代码无法执行

### ✨ 功能增强

#### 导出功能增强
- **新增**: `getAllMarkers()` 辅助函数，同时遍历 `drawnItems` 和 `markerClusterGroup`
- **增强**: Excel 导出现包含所有业务属性（销售等级、加油笔数、钱包会员比例等）
- **增强**: 自动排除技术内部字段（`marker-color`、`_leaflet_id` 等）
- **增强**: 范围圈数据导出为分号分隔格式（如 `1500;3000;5000`）
- **增强**: CSV 导出使用 Blob + BOM 确保中文正确显示

#### 导入功能增强
- **新增**: `COLUMN_ALIASES` 列名映射，支持多种列名格式（中文、英文、简写等）
- **增强**: 导入时保留所有额外业务字段（不再只保留固定列）
- **增强**: 范围圈字符串自动解析为数组
- **增强**: 导入失败时显示详细行号信息
- **优化**: 文件导入后自动重置 input，支持重复选择同一文件

#### 模板增强
- **新增**: Excel 模板包含完整业务字段示例（图层名称、销售等级、加油笔数、钱包会员比例、备注）
- **优化**: 模板列宽自动调整

---

## [v2.14.0] - 2026-01-29

### ✨ 新功能

#### 🎯 标记半径范围圈 (Radius Ring)
- **新增**: 标记属性编辑器中新增「范围圈」配置区块
- **预设半径**: 支持 1.5km、2km、3km、5km、10km 五个选项
- **多选支持**: 可同时选择多个半径，显示多个同心圆
- **真实地理距离**: 使用 `L.circle` 实现，地图缩放时自动按比例调整
- **虚线样式**: 不同半径使用不同虚线模式以便区分
- **完全联动**:
  - 标记隐藏 → 范围圈同步隐藏
  - 标记删除 → 范围圈自动清除
  - 标记移动 → 范围圈位置更新
- **图层隔离**: 范围圈不出现在图层列表，不参与聚合

### 💾 数据模型
- 范围圈数据存储在 `marker.feature.properties.radiusRings` 数组中
- 导出 GeoJSON 时自动包含范围圈配置

### 📦 代码同步
- 所有修改同步到 Geomap-app-lite

---

## [v2.13.0] - 2026-01-26

### ✨ 新功能

#### 📊 看板统计联动优化
- **修复**: 统计模块现正确统计点聚合（Cluster）模式中的标记
- **新增**: 显示隐藏图层数量提示，例如 "(包含 5 个隐藏标记)"
- **优化**: 快照加载时自动刷新统计看板

#### 📸 快照功能增强
- **新增**: 快照复制功能 - 时间轴每个快照新增"📄 复制"按钮
- **交互**: 点击复制按钮可基于现有快照创建副本（自动命名为 "xxx (副本)"）
- **完善**: 重命名、删除、复制三大操作齐全

#### 📂 图层分组 (文件夹组织)
- **重构**: 图层列表支持文件夹式展示，基于"自定义组"功能
- **交互**: 
  - 自定义组在列表中显示为可折叠文件夹
  - 未分组图层自动归入"未分组"区域
  - 点击组头可展开/收起
- **视觉**: 文件夹图标随展开状态切换（`fa-folder` / `fa-folder-open`）

#### 🎯 专业级框选功能
- **Shift + 拖动**: 绘制蓝色虚线矩形，释放后自动选中范围内所有标记
- **Ctrl + 单击**: 多选/取消选中单个标记（切换模式）
- **ESC 键**: 快速退出选择模式并清空选中
- **视觉反馈**: 
  - 拖动时显示蓝色虚线选区矩形（实时更新）
  - 选中标记显示放大 + 蓝色光晕高亮
  - 提示条实时显示 "已选 N" 动态计数
- **技术**: 自动禁用地图 `boxZoom` 防止框选时缩放冲突

#### 👁️ 浏览模式稳定性
- **UI 锁定**: 进入浏览模式时，图层列表中的删除/显隐操作按钮自动隐藏
- **CSS**: 添加 `body.browse-mode-active .layer-actions { display: none }` 强制锁定
- **体验**: 防止用户在只读浏览时误操作编辑图层

### 🐛 Bug 修复

#### 图层显隐 UI 同步
- **修复**: 点击隐藏后图层项变浅色，点击显示后颜色不恢复的问题
- **实现**: 添加 `.layer-hidden` CSS 样式（opacity: 0.5 + 删除线）
- **联动**: 图层项、地图显示、表格状态完全同步

#### 自定义组选择模式
- **修复**: "选择标记创建组"开启后只有十字光标，无法选择标记的问题
- **实现**: 
  - 完整的标记点击事件绑定
  - 顶部蓝色提示条显示操作指南
  - [取消] [完成创建] 按钮可见
  - 完成后弹窗输入组名
- **增强**: 支持单击、Ctrl 多选、Shift 框选三种选择方式

### 🎨 Lite 版本优化
- **移除**: 删除事件追踪器面板（`#eventTrackerPanel`）及相关 UI
- **简化**: 右键菜单移除"📋 事件追踪器"选项
- **定位**: Lite 版本专注核心地图编辑，不包含复杂事件管理

### 📝 文档更新
- **新增**: 同坐标多标记功能详解文档
  - 4 种添加方法（Excel 批量导入、GeoJSON、手动、属性表编辑）
  - Spiderfy 展开效果说明
  - MarkerGroupManager 使用指南

---

## [v2.12.0] - 2026-01-26

### ✨ 新功能

#### 产品规划文档
- 新增 `updatedocs/PRODUCT_PLAN_P0.md` 产品规划与优先级文档
- 明确 Geomap-app-lite **不包含事件追踪器** 功能

#### 图层管理增强
- **图层可见性切换**：眼睛图标切换 `fa-eye`/`fa-eye-slash`，隐藏图层半透明+划线效果
- **图层样式编辑器**：颜色选择器、透明度滑块、线宽控制，实时预览
- **图层操作增强**：`renameLayer/deleteLayer` 支持搜索 drawnItems、markerClusterGroup、markerGroupManager

### 🐛 Bug 修复

#### 自定义组功能
- 修复「选择标记创建组」无法选中标记的问题
- 新增 `_bindMarkerClicks()` 和 `_unbindMarkerClicks()` 方法
- 进入选择模式时自动绑定所有标记的点击事件

#### 图层按钮修复
- 修复图层列表中隐藏/显示、重命名、删除按钮无效的问题
- 删除图层后同步更新表格和看板

---

## [v2.11.0] - 2026-01-23

### ✨ 新功能

#### 自定义底图
- 新增底图选择下拉框（高级工具 → 底图选择）
- 支持：OSM、卫星影像、暗色/亮色主题、地形图、高德地图、高德卫星
- 预留 API Key 常量：`AMAP_MAP_KEY`、`TENCENT_MAP_KEY`、`TIANDITU_TOKEN`

#### 点聚合功能
- 引入 Leaflet.markercluster 插件
- 聚合点显示 "500+" 当数量 ≥ 500
- **默认关闭**，通过复选框"启用点聚合"开启
- 优化：`maxClusterRadius=60`，`disableClusteringAtZoom=16`

#### 清空所有图层
- 新增红色"清空所有图层"按钮（数据导入导出 → 最下方）
- 点击后确认对话框，防止误操作

### 🐛 Bug 修复
- 移除不可用底图选项（腾讯地图、天地图）
- 修复导入标记不触发聚合的问题

---

## [v2.10.0] - 2026-01-17

### ✨ 新功能

#### 分发构建版本
- **单网页版** (`index-single.html`)：所有 JS/CSS 内联到一个 HTML 文件
- **便携版** (`/portable`)：独立目录结构，可拷贝即用或打包为桌面应用
- **构建脚本** (`build-single.py`)：自动合并生成单文件版本

#### API 挂接模块 (`portable/js/api-hooks.js`)
- `GeoMapAPI.loadGeoJSON()` / `saveGeoJSON()` - GeoJSON 数据操作
- `GeoMapAPI.listArchives()` / `loadArchive()` / `saveArchive()` - 存档管理
- `GeoMapAPI.listSnapshots()` / `saveSnapshot()` / `loadSnapshot()` - 快照管理
- `GeoMapAPI.loadUserConfig()` / `saveUserConfig()` - 用户配置
- `GeoMapAPI.geocodeAddress()` - 地理编码服务
- 当前使用 localStorage 实现，后续可替换为后端 API

### 📝 文档更新
- README.md 新增"构建与分发"章节

---

## [v2.9.2] - 2026-01-14

### 🐛 Bug 修复

#### 浏览模式核心功能修复
- **快照切换失败**：`_resetRuntimeState()` 中 `selectionManager.clear()` → `selectionManager.deselect()`
- **X 退出按钮无效**：同上，TypeError 导致函数执行中断
- **浏览模式 UI 重复**：移除 `_showBrowseModeOverlay()`，仅保留顶部操作条

#### 图层面板无法打开
- **问题**：事件监听器未正确绑定
- **修复**：在 HTML 中添加 `onclick="toggleLayerPanel()"`
- **新增 CSS**：`.layer-panel` 显示/隐藏样式

#### 浏览模式状态条优化
- **新设计**：居中悬浮小胶囊（非全宽横幅）
- **布局**：[✕ 退出] [👁️ 只读浏览] [快照名] [✓ 应用]
- **插入位置**：`document.body` 顶部固定定位

### 📦 代码同步
- 所有修复同步到 Geomap-app-lite

---

## [v2.9.1] - 2026-01-13

### 🐛 Bug 修复

#### 历史地图浏览模式退出修复
- **问题**：退出浏览模式后，编辑功能仍被禁用
- **修复**：
  - 增强 `_disableEditControls()` / `_enableEditControls()`
  - 添加 ESC 键退出监听
  - 添加全局 `exitHistoryBrowseModeSafe()` 函数
  - 切换 Accordion 时自动退出浏览模式

#### Leaflet.draw 工具栏定位修复
- **问题**：工具栏与左侧面板重叠
- **修复**：调整 `margin-left: 312px`，折叠状态 `88px`

### 📝 文档重构
- **CHANGELOG 统一**：根目录 CHANGELOG.md 为唯一权威日志
- **README 精简**：从 273 行精简到 ~70 行
- **updatedocs 整理**：CHANGELOG.md → ARCHIVE_CHANGELOG.md

---

## [v2.9.0] - 2026-01-13

### ✨ 新功能

#### 统一悬浮面板系统（Floating Panel System）
- **毛玻璃效果**：所有面板 `backdrop-filter: blur(14px)` + 半透明背景
- **统一基类**：`.floating-panel` 基类定义圆角、阴影、边框
- **CSS 变量**：`--bg-glass`、`--border-glass`、`--shadow-float` 等统一管理

#### 左侧 Dock 折叠模式
- **图标模式**：折叠后显示 5 个图标（搜索/导入/图层/历史/工具）
- **Tooltip**：悬停显示功能名称
- **一键展开**：点击图标展开对应功能模块

#### 图层管理面板升级
- **固定头部**：标题 + 关闭按钮固定在顶部
- **搜索栏**：实时过滤图层列表
- **可折叠分组**：图层列表/图层详情/统计汇总 可独立折叠
- **滚动列表**：`max-height: 40vh` + `overflow-y: auto`

### 🐛 Bug 修复
- **地图不显示**：修复 UI 重构后 `#map` 被嵌套在隐藏元素内的问题
- **Dock 图标不可见**：添加 `.dock-icon i` 显式样式
- **Leaflet.draw 图标不可见**：改用 `background-color:` 保留 sprite 图标

### 🎨 UI 优化
- **缩放控件**：移至左下角，44×44px 点击区域
- **自定义滚动条**：6px 宽度，透明轨道
- **按钮系统**：主按钮 `#1677FF`、次按钮描边、文字按钮

---

## [v2.8.0] - 2026-01-13

### ✨ 新功能

#### 快照浏览模式
- **进入浏览**：点击历史地图模块的 👁️ 按钮
- **快照切换**：浏览模式下点击快照列表项立即加载
- **状态隔离**：进入时保存编辑态，退出时自动恢复
- **禁用编辑**：浏览模式下绘制控件/导入/清空按钮禁用

#### 表格定位按钮
- **新增列**：表格末尾添加「定位」按钮列
- **按钮点击**：flyTo + 高亮 + 展开同坐标组

#### 图层搜索功能
- **搜索栏**：图层详情面板顶部添加搜索输入框
- **模糊匹配**：按名称/类型/地址匹配

### 🐛 Bug 修复
- **GeoJSON 导入「替换」模式**：每个清理步骤独立 try/catch，方法调用前检查
- **快照数据隔离**：加载快照前调用 `_resetRuntimeState()`

---

## [v2.7.1] - 2026-01-12
- ✅ 「地图历史」→「历史地图」名称统一
- ✅ 保存按钮颜色统一为蓝色
- ✅ 工具菜单改为横排显示
- ✅ 左侧面板收起时隐藏历史地图模块

---

## [v2.7.0] - 2026-01-12
- ✨ 「历史地图」模块（原时间轴），默认收起
- ✨ 右下角工具入口合并（表格 + 看板 → 统一工具菜单）
- ✅ 移除异常浮动图标

---

## [v2.6.0] - 2026-01-12

### ✨ 新功能

#### 时间轴快照系统
- **快照保存**：保存当前地图完整状态（标记样式、视图状态、自定义组）
- **快照加载**：点击时间点恢复该状态
- **快照管理**：重命名、删除
- **localStorage 持久化**

#### 看板统计面板
- 当前时间点名称、总标记数
- 按类型分组统计
- 颜色色块预览 + 图标预览
- 实时刷新

---

## [v2.5.1] - 2026-01-12
- ✅ CSS Grid 布局重构（左侧面板与底部表格联动）
- ✅ 表格展开时面板高度自动缩短
- ✅ 平滑过渡动画 + 地图自动重绘

---

## [v2.5.0] - 2026-01-12
- ✨ **自定义组管理器**（多选标记创建命名组）
- ✅ 组 CRUD 操作 + localStorage 持久化
- ✅ 组导出 GeoJSON
- ✅ 多选模式高亮显示

---

## [v2.4.0] - 2026-01-09
- ✨ 图层统计功能（按类型分组 + 全局汇总）
- ✨ 四向联动（Table/地图/图层面板/属性编辑器）
- ✨ SelectionManager 统一选中状态管理

---

## [v2.3.0] - 2026-01-09
- ✨ 组合标记功能（同坐标合并 + 数量徽标）
- ✨ 放射展开 Spiderfy（圆形/螺旋布局）
- ✅ ESC/空白点击收起
- ✅ 数据完整性保障（不修改原始坐标）

---

## [v2.2.1] - 2026-01-09
- ✅ 中文字段全平台支持（弹窗、编辑器、表格动态列）
- ✅ "添加/管理事件"按钮功能修复与统一
- ✅ 标记点击交互优化（弹窗与高亮并存）

---

## [v2.2.0] - 2026-01-09
- ✅ 中文字段完整支持
- ✅ 右键属性编辑器修复
- ✅ 左键事件功能增强（双击打开事件追踪器）

---

## [v2.1.0] - 2026-01-08
- ✅ 表格视图面板（Tabulator）
- ✅ 虚拟滚动、单元格编辑
- ✅ 双向联动

---

## [v2.0.0] - 2026-01-08
- ✅ 侧边抽屉属性编辑器
- ✅ 交互系统重构
- ✅ 同位置多标记支持

---

## [v1.2.0] - 2026-01-08
- ✅ 智能端口检测（8000-8099）
- ✅ 新增 `server.py`

---

## [v1.0.0] - 基础版本
- ✨ 地图编辑（标记、线条、多边形）
- ✨ 自定义图标与颜色
- ✨ GeoJSON 导入/导出
- ✨ 事件追踪器
- ✨ 无限命名存档
- ✨ 多种底图切换
